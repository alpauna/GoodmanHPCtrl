<html><head><title>Dashboard - Goodman HP</title>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
nav{background:#333;padding:10px 20px;display:flex;align-items:center;gap:18px;}
nav a{color:#fff;text-decoration:none;font-size:14px;padding:6px 12px;border-radius:4px;}
nav a:hover,nav a.active{background:#4CAF50;}
nav .brand{font-weight:bold;font-size:16px;margin-right:auto;color:#fff;}
.content{max-width:600px;margin:20px auto;padding:0 20px;}
.card{background:#fff;border:1px solid #ddd;border-radius:6px;padding:15px;margin-bottom:15px;}
.card h3{margin:0 0 10px 0;color:#333;font-size:15px;}
.state-banner{padding:20px;border-radius:6px;text-align:center;color:#fff;margin-bottom:15px;}
.state-name{font-size:28px;font-weight:bold;}
.state-runtime{font-size:14px;opacity:0.9;margin-top:5px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border:1px solid #ddd;border-radius:4px;}
.indicator .label{font-size:14px;color:#333;font-weight:bold;}
.indicator .val{font-size:13px;color:#555;margin-left:auto;}
.dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.dot.on{background:#4CAF50;}
.dot.off{background:#ccc;}
.fault-row{display:flex;flex-wrap:wrap;gap:8px;}
.pill{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:bold;}
.pill.ok{background:#e8f5e9;color:#2e7d32;}
.pill.active{background:#ffebee;color:#c62828;}
.temp-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;}
.temp-row:last-child{border-bottom:none;}
.temp-name{color:#555;font-size:14px;}
.temp-value{font-weight:bold;color:#333;font-size:14px;}
.footer{text-align:center;color:#999;font-size:12px;margin-top:10px;}
.sc-group{margin-left:auto;display:flex;align-items:center;gap:4px;}
.sc-pill{padding:2px 6px;font-size:10px;}
.sep{color:#ccc;font-size:14px;}
.footer.error{color:#d32f2f;}
.wifi-bars{display:flex;align-items:flex-end;gap:2px;height:16px;}
.wifi-bars span{width:4px;background:#ccc;border-radius:1px;transition:background 0.3s;}
.wifi-bars span.active{background:#4CAF50;}
.wifi-bars span:nth-child(1){height:4px;}
.wifi-bars span:nth-child(2){height:7px;}
.wifi-bars span:nth-child(3){height:11px;}
.wifi-bars span:nth-child(4){height:16px;}
.wifi-info{display:flex;align-items:center;gap:6px;margin-left:auto;}
.chart-card h3{display:flex;align-items:center;justify-content:space-between;}
.chart-card h3 select{font-size:13px;padding:2px 6px;border:1px solid #ccc;border-radius:4px;}
.chart-container{margin-bottom:12px;}
.chart-container h4{margin:0 0 4px 0;font-size:13px;color:#555;}
.chart-container canvas{width:100%;height:150px;border:1px solid #eee;border-radius:4px;background:#fafafa;display:block;}
</style></head><body>
<nav><span class='brand'>Goodman HP</span>
<a href='/'>Home</a>
<a href='/dashboard' class='active'>Dashboard</a>
<a href='/config'>Config</a>
<a href='/update'>Update</a>
<a href='/log/view'>Log</a>
<a href='/heap/view'>Heap</a>
<a href='#' onclick="if(confirm('Reboot device?')){fetch('/reboot',{method:'POST',headers:{'Authorization':'Basic '+btoa(prompt('user:pass','admin:'))}}).then(r=>r.ok?alert('Rebooting...'):alert('Failed'))};return false" style='margin-left:auto;background:#d32f2f;'>Reboot</a>
</nav>
<div class='content'>

<div id='stateBanner' class='state-banner' style='background:#9e9e9e;'>
<div class='state-name' id='stateName'>--</div>
<div class='state-runtime' id='stateRuntime'></div>
</div>

<div class='card'>
<h3>Protection Status</h3>
<div class='fault-row'>
<span class='pill ok' id='fStartup'>Startup Protect</span>
<span class='pill ok' id='fDefrost'>Defrost</span>
<span class='pill ok' id='fLPS'>LPS Fault</span>
<span class='pill ok' id='fLowTemp'>Low Temp</span>
<span class='pill ok' id='fCompOT'>Comp OT</span>
<span class='pill ok' id='fSuctLT'>Suct LT</span>
</div>
</div>

<div class='card'>
<h3>Inputs</h3>
<div class='grid'>
<div class='indicator'><span class='dot off' id='dY'></span><span class='label'>Y</span><span class='val' id='vY'>--</span></div>
<div class='indicator'><span class='dot off' id='dO'></span><span class='label'>O</span><span class='val' id='vO'>--</span></div>
<div class='indicator'><span class='dot off' id='dLPS'></span><span class='label'>LPS</span><span class='val' id='vLPS'>--</span></div>
<div class='indicator'><span class='dot off' id='dDFT'></span><span class='label'>DFT</span><span class='val' id='vDFT'>--</span></div>
</div>
</div>

<div class='card'>
<h3>Outputs</h3>
<div class='grid'>
<div class='indicator'><span class='dot off' id='dFAN'></span><span class='label'>FAN</span><span class='val' id='vFAN'>--</span></div>
<div class='indicator'><span class='dot off' id='dCNT'></span><span class='label'>CNT</span><div class='sc-group'><span class='pill ok sc-pill' id='fShortCycle'>SC</span><span class='sep'>|</span><span class='val' id='vCNT'>--</span></div></div>
<div class='indicator'><span class='dot off' id='dW'></span><span class='label'>W</span><span class='val' id='vW'>--</span></div>
<div class='indicator'><span class='dot off' id='dRV'></span><span class='label'>RV</span><span class='val' id='vRV'>--</span></div>
</div>
</div>

<div class='card'>
<h3>Temperatures</h3>
<div id='temps'>
<div class='temp-row'><span class='temp-name'>Loading...</span></div>
</div>
</div>

<div class='card'>
<h3>System</h3>
<div class='grid'>
<div class='indicator'><span class='label'>CPU 0</span><span class='val' id='vCpu0'>--%</span></div>
<div class='indicator'><span class='label'>CPU 1</span><span class='val' id='vCpu1'>--%</span></div>
<div class='indicator'><span class='label'>Heap</span><span class='val' id='vHeap'>--</span></div>
<div class='indicator'><span class='label'>WiFi</span><div class='wifi-info'><div class='wifi-bars' id='wifiBars'><span></span><span></span><span></span><span></span></div><span class='val' id='vWifi'>--</span></div></div>
</div>
</div>

<div class='card chart-card'>
<h3><span>Temperature History</span>
<select id='timeRange'>
<option value='1'>1 Hour</option>
<option value='6' selected>6 Hours</option>
<option value='24'>24 Hours</option>
<option value='168'>7 Days</option>
</select>
</h3>
<div id='chartStatus' style='text-align:center;color:#999;font-size:12px;margin:4px 0;'></div>
<div id='charts'></div>
</div>

<div class='footer' id='footer'>Connecting...</div>
</div>
<script>
var stateColors={
  'COOL':'#2196F3','HEAT':'#f44336','DEFROST':'#ff9800',
  'OFF':'#9e9e9e','ERROR':'#d32f2f','LOW_TEMP':'#7b1fa2'
};
var tempNames={
  'COMPRESSOR_TEMP':'Compressor','SUCTION_TEMP':'Suction',
  'AMBIENT_TEMP':'Ambient','CONDENSER_TEMP':'Condenser','LIQUID_TEMP':'Liquid Line'
};

function setDot(id,on){
  var el=document.getElementById(id);
  if(el) el.className='dot '+(on?'on':'off');
}
function setPill(id,active){
  var el=document.getElementById(id);
  if(el) el.className='pill '+(active?'active':'ok');
}
function setText(id,txt){
  var el=document.getElementById(id);
  if(el) el.textContent=txt;
}

function update(d){
  // State banner
  var banner=document.getElementById('stateBanner');
  var color=stateColors[d.state]||'#9e9e9e';
  banner.style.backgroundColor=color;
  setText('stateName',d.state||'--');
  var rt=d.heatRuntimeMin||0;
  var hrs=Math.floor(rt/60);
  var mins=rt%60;
  setText('stateRuntime','Heat Runtime: '+(hrs>0?hrs+'h ':'')+mins+'m');

  // Faults / Protection
  setPill('fStartup',d.startupLockout);
  var su=document.getElementById('fStartup');
  if(su){var sec=d.startupLockoutRemainSec||0;var m=Math.ceil(sec/60);su.textContent=d.startupLockout?'Startup Protect: '+m+'m':'Startup Protect';}
  setPill('fShortCycle',d.shortCycleProtection);
  setPill('fDefrost',d.defrost);
  setPill('fLPS',d.lpsFault);
  setPill('fLowTemp',d.lowTemp);
  setPill('fCompOT',d.compressorOverTemp);
  setPill('fSuctLT',d.suctionLowTemp);

  // Inputs
  var ins=d.inputs||{};
  var inKeys=['Y','O','LPS','DFT'];
  for(var i=0;i<inKeys.length;i++){
    var k=inKeys[i];
    var v=ins[k];
    setDot('d'+k,v===true);
    setText('v'+k,v===true?'ON':v===false?'OFF':'--');
  }

  // Outputs
  var outs=d.outputs||{};
  var outKeys=['FAN','CNT','W','RV'];
  for(var i=0;i<outKeys.length;i++){
    var k=outKeys[i];
    var v=outs[k];
    setDot('d'+k,v===true);
    setText('v'+k,v===true?'ON':v===false?'OFF':'--');
  }

  // Temps
  var tc=document.getElementById('temps');
  var ts=d.temps||{};
  var order=['AMBIENT_TEMP','COMPRESSOR_TEMP','SUCTION_TEMP','CONDENSER_TEMP','LIQUID_TEMP'];
  var html='';
  for(var i=0;i<order.length;i++){
    var k=order[i];
    var name=tempNames[k]||k;
    var val=ts[k];
    if(val!==undefined){
      html+="<div class='temp-row'><span class='temp-name'>"+name+"</span><span class='temp-value'>"+val.toFixed(1)+"&deg;F</span></div>";
    }else{
      html+="<div class='temp-row'><span class='temp-name'>"+name+"</span><span class='temp-value' style='color:#999'>--</span></div>";
    }
  }
  tc.innerHTML=html;

  // System
  setText('vCpu0',d.cpuLoad0!==undefined?d.cpuLoad0+'%':'--%');
  setText('vCpu1',d.cpuLoad1!==undefined?d.cpuLoad1+'%':'--%');
  if(d.freeHeap!==undefined){var kb=Math.round(d.freeHeap/1024);setText('vHeap',kb+'KB');}
  if(d.wifiRSSI!==undefined){
    var rssi=d.wifiRSSI;
    setText('vWifi',rssi+'dBm');
    var bars=rssi>=-50?4:rssi>=-60?3:rssi>=-70?2:rssi>=-80?1:0;
    var el=document.getElementById('wifiBars');
    if(el){var sp=el.children;for(var i=0;i<4;i++){sp[i].className=i<bars?'active':'';}}
  }

  // Footer
  var now=new Date();
  var ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
  var ft=document.getElementById('footer');
  ft.textContent='Last updated: '+ts;
  ft.className='footer';

  // Append live data to charts
  appendLiveTemp(d);
}

function fetchState(){
  var xhr=new XMLHttpRequest();
  xhr.open('GET','/state',true);
  xhr.timeout=5000;
  xhr.onload=function(){
    if(xhr.status===200){
      try{ update(JSON.parse(xhr.responseText)); }catch(e){}
    }
  };
  xhr.onerror=function(){
    var ft=document.getElementById('footer');
    ft.textContent='Connection lost';
    ft.className='footer error';
  };
  xhr.ontimeout=function(){
    var ft=document.getElementById('footer');
    ft.textContent='Connection timeout';
    ft.className='footer error';
  };
  xhr.send();
}

fetchState();
setInterval(fetchState,2000);

// ---- Temperature History Charts ----
var chartSensors=[
  {key:'AMBIENT_TEMP',dir:'ambient',color:'#2196F3'},
  {key:'COMPRESSOR_TEMP',dir:'compressor',color:'#f44336'},
  {key:'SUCTION_TEMP',dir:'suction',color:'#4CAF50'},
  {key:'CONDENSER_TEMP',dir:'condenser',color:'#ff9800'},
  {key:'LIQUID_TEMP',dir:'liquid',color:'#9C27B0'}
];
var chartData={};
var chartCanvases={};
var chartInited=false;
var lastAppendEpoch=0;

function initCharts(){
  var c=document.getElementById('charts');
  c.innerHTML='';
  for(var i=0;i<chartSensors.length;i++){
    var s=chartSensors[i];
    chartData[s.key]=[];
    var div=document.createElement('div');
    div.className='chart-container';
    var h4=document.createElement('h4');
    h4.textContent=tempNames[s.key]||s.key;
    div.appendChild(h4);
    var cvs=document.createElement('canvas');
    cvs.width=560;cvs.height=150;
    div.appendChild(cvs);
    c.appendChild(div);
    chartCanvases[s.key]=cvs;
  }
  chartInited=true;
}

function loadHistory(){
  var range=parseInt(document.getElementById('timeRange').value);
  var status=document.getElementById('chartStatus');
  status.textContent='Loading history...';
  var daysNeeded=Math.ceil(range/24);
  if(daysNeeded<1) daysNeeded=1;

  // Load each sensor independently
  var sensorsLoaded=0;
  for(var si=0;si<chartSensors.length;si++){
    (function(sensor){
      var xhr=new XMLHttpRequest();
      xhr.open('GET','/temps/history?sensor='+sensor.dir,true);
      xhr.onload=function(){
        if(xhr.status===200){
          try{
            var resp=JSON.parse(xhr.responseText);
            var files=(resp.files||[]).sort(function(a,b){return b.date.localeCompare(a.date);});
            var toFetch=files.slice(0,daysNeeded);
            toFetch.reverse();
            if(toFetch.length===0){
              chartData[sensor.key]=[];
              sensorsLoaded++;
              if(sensorsLoaded===chartSensors.length) onAllLoaded(range);
              return;
            }
            var fetched=0;
            var rows=[];
            for(var fi=0;fi<toFetch.length;fi++){
              (function(dateStr){
                var csvXhr=new XMLHttpRequest();
                csvXhr.open('GET','/temps/history?sensor='+sensor.dir+'&date='+dateStr,true);
                csvXhr.onload=function(){
                  if(csvXhr.status===200) parseCSV(csvXhr.responseText,rows);
                  fetched++;
                  if(fetched===toFetch.length){
                    rows.sort(function(a,b){return a.t-b.t;});
                    var now=Math.floor(Date.now()/1000);
                    var cutoff=now-(range*3600);
                    var filtered=[];
                    for(var r=0;r<rows.length;r++){
                      if(rows[r].t>=cutoff) filtered.push(rows[r]);
                    }
                    // Decimate to max 500 points
                    if(filtered.length>500){
                      var step=Math.ceil(filtered.length/500);
                      var dec=[];
                      for(var r=0;r<filtered.length;r+=step) dec.push(filtered[r]);
                      filtered=dec;
                    }
                    chartData[sensor.key]=filtered;
                    if(filtered.length>0) lastAppendEpoch=Math.max(lastAppendEpoch,filtered[filtered.length-1].t);
                    sensorsLoaded++;
                    if(sensorsLoaded===chartSensors.length) onAllLoaded(range);
                  }
                };
                csvXhr.onerror=function(){fetched++;if(fetched===toFetch.length){sensorsLoaded++;if(sensorsLoaded===chartSensors.length) onAllLoaded(range);}};
                csvXhr.send();
              })(toFetch[fi].date);
            }
          }catch(e){sensorsLoaded++;if(sensorsLoaded===chartSensors.length) onAllLoaded(range);}
        }else{sensorsLoaded++;if(sensorsLoaded===chartSensors.length) onAllLoaded(range);}
      };
      xhr.onerror=function(){sensorsLoaded++;if(sensorsLoaded===chartSensors.length) onAllLoaded(range);};
      xhr.send();
    })(chartSensors[si]);
  }
}

function parseCSV(text,rows){
  var lines=text.split('\n');
  for(var i=0;i<lines.length;i++){
    var line=lines[i].trim();
    if(!line) continue;
    var cols=line.split(',');
    if(cols.length<2) continue;
    var t=parseInt(cols[0]);
    var v=parseFloat(cols[1]);
    if(!isNaN(t)&&!isNaN(v)) rows.push({t:t,v:v});
  }
}

function onAllLoaded(range){
  var total=0;
  for(var i=0;i<chartSensors.length;i++) total+=chartData[chartSensors[i].key].length;
  document.getElementById('chartStatus').textContent=total+' data points loaded';
  renderAllCharts();
}

function renderChart(sensorIdx){
  var s=chartSensors[sensorIdx];
  var canvas=chartCanvases[s.key];
  if(!canvas) return;
  var data=chartData[s.key];

  var rect=canvas.getBoundingClientRect();
  var dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;
  canvas.height=rect.height*dpr;
  var ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);

  var W=rect.width,H=rect.height;
  var pad={top:10,right:10,bottom:25,left:45};
  var plotW=W-pad.left-pad.right;
  var plotH=H-pad.top-pad.bottom;

  ctx.clearRect(0,0,W,H);

  if(data.length<2){
    ctx.fillStyle='#999';ctx.font='12px Arial';ctx.textAlign='center';
    ctx.fillText('No data',W/2,H/2);
    return;
  }

  var minV=Infinity,maxV=-Infinity;
  for(var i=0;i<data.length;i++){
    if(data[i].v<minV) minV=data[i].v;
    if(data[i].v>maxV) maxV=data[i].v;
  }
  var yR=maxV-minV;
  if(yR<2){yR=2;minV-=1;maxV+=1;}
  minV-=yR*0.05;maxV+=yR*0.05;
  yR=maxV-minV;

  var tMin=data[0].t,tMax=data[data.length-1].t;
  var tR=tMax-tMin;if(tR===0)tR=1;

  function xPx(t){return pad.left+((t-tMin)/tR)*plotW;}
  function yPx(v){return pad.top+plotH-((v-minV)/yR)*plotH;}

  // Grid lines
  ctx.strokeStyle='#eee';ctx.lineWidth=1;
  ctx.font='10px Arial';ctx.fillStyle='#999';ctx.textAlign='right';
  for(var i=0;i<=5;i++){
    var val=minV+(yR*i/5);
    var y=yPx(val);
    ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(W-pad.right,y);ctx.stroke();
    ctx.fillText(val.toFixed(0)+'\u00B0F',pad.left-4,y+3);
  }

  // X axis labels
  ctx.textAlign='center';ctx.fillStyle='#999';
  for(var i=0;i<=6;i++){
    var t=tMin+(tR*i/6);
    var x=xPx(t);
    var d=new Date(t*1000);
    var label;
    if(tR>86400){
      label=(d.getMonth()+1)+'/'+d.getDate()+' '+d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
    }else{
      label=d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
    }
    ctx.fillText(label,x,H-4);
  }

  // Data line
  ctx.strokeStyle=s.color;ctx.lineWidth=1.5;ctx.lineJoin='round';
  ctx.beginPath();
  ctx.moveTo(xPx(data[0].t),yPx(data[0].v));
  for(var i=1;i<data.length;i++){
    ctx.lineTo(xPx(data[i].t),yPx(data[i].v));
  }
  ctx.stroke();

  // Current value label
  var lastVal=data[data.length-1].v;
  ctx.fillStyle=s.color;ctx.font='bold 12px Arial';ctx.textAlign='right';
  ctx.fillText(lastVal.toFixed(1)+'\u00B0F',W-pad.right-4,pad.top+14);
}

function renderAllCharts(){
  for(var i=0;i<chartSensors.length;i++) renderChart(i);
}

function appendLiveTemp(d){
  if(!chartInited) return;
  var ts=d.temps||{};
  var now=Math.floor(Date.now()/1000);
  if(now-lastAppendEpoch<25) return;
  lastAppendEpoch=now;

  var range=parseInt(document.getElementById('timeRange').value);
  var cutoff=now-(range*3600);

  for(var i=0;i<chartSensors.length;i++){
    var key=chartSensors[i].key;
    var val=ts[key];
    if(val!==undefined){
      chartData[key].push({t:now,v:val});
      while(chartData[key].length>0&&chartData[key][0].t<cutoff) chartData[key].shift();
    }
  }
  renderAllCharts();
}

// Init charts on page load
initCharts();
loadHistory();
document.getElementById('timeRange').addEventListener('change',function(){loadHistory();});
window.addEventListener('resize',function(){if(chartInited) renderAllCharts();});
</script>
</body></html>
